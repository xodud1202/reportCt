<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="api.dao.PointDao">
	<select id="getPointList" resultType="api.domain.Point">
		SELECT CUST_POINT_IDX
		     , CUST_NO
		     , GIVE_PNT_AMT
		     , USE_PNT_AMT
		     , LEFT_PNT_AMT
		     , EXT_DT
		     , REG_DT
		     , UPD_DT
		FROM   T_CUST_POINT
		WHERE  1=1
	</select>

	<!-- 고객 포인트 합계 정보 -->
	<select id="getCustPointSumInfo" resultType="map" parameterType="api.domain.Point">
		/* Point.getCustPointSumInfo : 고객 포인트 합계 정보 */
		SELECT CUST_NO
		     , SUM(LEFT_PNT_AMT) AS SUM_PNT_AMT
		FROM   T_CUST_POINT CP
		WHERE  CUST_NO = #{custNo}
		AND    EXT_DT > NOW()
		GROUP  BY CUST_NO
	</select>

	<!-- 고객 포인트 합계 정보 -->
	<select id="getCustPointHstList" resultType="map" parameterType="api.domain.Point">
		/* Point.getCustPointHstList : 고객 포인트 합계 정보 */
		SELECT A.CUST_NO
		     , A.EXT_DT
		     , A.ORD_NO
		     , A.HST_DESC
		     , A.PNT_AMT
		     , CASE WHEN A.GBN = 'USE' THEN '사용' WHEN A.GBN = 'SAVE' THEN '적립' ELSE '그외' END AS GBN
		FROM   (SELECT CP.CUST_NO
		             , CP.EXT_DT
		             , CPH.PNT_AMT
		             , CPH.HST_DESC
		             , CPH.ORD_NO
		             , CPH.GBN
		        FROM   T_CUST_POINT CP
		        INNER  JOIN T_CUST_POINT_HST CPH
		        ON     CP.CUST_POINT_IDX = CPH.CUST_POINT_IDX
		        WHERE  CUST_NO = #{custNo}
		        AND    CPH.DEL_YN = 'N'
		        ORDER  BY CPH.REG_DT DESC) A
		LIMIT  10 OFFSET #{startNo}
	</select>

	<!-- 고객 포인트 테이블 생성 -->
	<insert id="insertCustPoint" parameterType="api.domain.Point">
		/* Point.insertCustPoint : 고객 포인트 테이블 생성 */
		INSERT INTO T_CUST_POINT (
		       CUST_NO
		     , GIVE_PNT_AMT
		     , USE_PNT_AMT
		     , LEFT_PNT_AMT
		     , EXT_DT
		     , REG_DT
		     , UPD_DT
		) VALUES (
		       #{custNo}
		     , #{givePntAmt}
		     , 0
		     , #{leftPntAmt}
		     , NOW() + 365
		     , NOW()
		     , NOW()
		)
		<selectKey resultType="Long" keyProperty="custPointIdx" order="AFTER">
		    SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>

	<!-- 고객 포인트 적립/사용 이력 테이블 생성 -->
	<insert id="insertCustPointHst" parameterType="api.domain.Point">
		/* Point.insertCustPointHst : 고객 포인트 적립/사용 이력 테이블 생성 */
		INSERT INTO T_CUST_POINT_HST (
		       CUST_POINT_IDX
		     , GBN
		     , HST_DESC
		     , PNT_AMT
		     , ORD_NO
		     , DEL_YN
		     , REG_DT
		     , UPD_DT
		) VALUES (
		       #{custPointIdx}
		     , #{gbn}
		     , #{hstDesc}
		     , #{pntAmt}
		     , #{ordNo}
		     , 'N'
		     , NOW()
		     , NOW()
		)
	</insert>
</mapper>